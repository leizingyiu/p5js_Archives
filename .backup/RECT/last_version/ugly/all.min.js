function sphericalCoordinate(perspectiveK,W,H,midX,midY,radianX,radianY){return function(ix,iy,R){let x=ix,y=iy,whMin=Math.min(W,H),whMax=Math.max(W,H),radx=x/(whMin/2)*(radianX/Math.PI),rady=y/(whMin/2)*(radianY/Math.PI),dx=R*Math.sin(radx*Math.PI/2)*Math.cos(rady*Math.PI/2),dy=R*Math.sin(rady*Math.PI/2),dz=R*Math.cos(radx*Math.PI/2)*Math.cos(rady*Math.PI/2),perspect=Math.pow(perspectiveK,dz/R),Dx,Dy;return[dx/perspect,dy/perspect,perspect]}}function rectOnSphere(x,y,w,h,r){let xArr=[1,-1,-1,1].map(i=>i*w/2+x),yArr=[1,1,-1,-1].map(i=>i*h/2+y),pArr=[];for(let i=0;i<4;i++)pArr.push(...sphereFun(xArr[i],yArr[i],r)),pArr.pop();let p=[].concat.apply([],pArr);quad(...p)}function graPointsOnSphere(x,y,w,h,r){let xd=Math.cos(Math.atan2(y,x)),yd=Math.sin(Math.atan2(y,x)),xArr=[-xd,xd].map(i=>i*w*1+x),yArr=[-yd,yd].map(i=>i*h*1+y),pArr=[],p;for(let i=0;i<2;i++)pArr.push(...sphereFun(xArr[i],yArr[i],r)),pArr.pop();return[].concat.apply([],pArr)}function guiHsvToP5Hsv(hsvArray){let result=Object.values(hsvArray);return result[1]=100*result[1],result[2]=100*result[2],result}function extendArr(array,l,fn=((p,start,end)=>start*(1-p)+end*p)){let bArr=[...new Array(l)];return bArr=bArr.map((i,idx,arr)=>{let l,D,d=idx/(arr.length-1)*(array.length-1),Idx=Math.floor(d),proportion=Math.abs(d-Idx),start=array[Idx],end=array[Idx+1],result;return d==Idx?array[d]:fn(proportion,start,end)}),bArr}function cleanArr(arr,threshold){let a=[...arr];if(Math.abs(a.filter(i=>i<threshold).length-a.length)<2)return a;for(let i=a.length-1;i>0&&a[i]<threshold;i--)a.pop();for(let i=0;i<a.length&&a[i]<threshold;i++)a.shift();return a}function arrCleanAndExtend(arr,threshold,interpolationFn){let a=[...arr],l=a.length;return a=cleanArr(a,threshold),a=extendArr(a,l,interpolationFn),a}function hsl2hsv(h,s,l,v=s*Math.min(l,1-l)+l){return[h,v?2-2*l/v:0,v]}function hsv2hsl(h,s,v,l=v-v*s/2,m=Math.min(l,1-l)){return[h,m?(v-l)/m:0,l]}class Cell{constructor(w,h,x,y,rowIdx,colIdx,rowN,colN,R){this.h=h,this.w=w,this.x=x,this.y=y,this.dx=x,this.dy=y,this.dh=h,this.dw=w,this.R=R,this.dR=R,this.rowIdx=rowIdx,this.colIdx=colIdx,this.rowN=rowN,this.colN=colN,this.level=0,this.target=cnv,this.fillColor=guiHsvToP5Hsv(settings.fillColor),this.strokeColor=guiHsvToP5Hsv(settings.strokeColor),this.hslF="",this.hslS="",this.graX1=0,this.graX2=0,this.graY1=0,this.graY2=0}update(level){this.level=level;let m=1,n=1.05,l=map(1-this.level,0,1,1,n);this.dx=this.x*l,this.dy=this.y*l,this.dh=this.h*l,this.dw=this.w*l,this.dR=this.R/Math.pow(l,2),this.fillColor=guiHsvToP5Hsv(settings.fillColor),this.fillColor[0]=(this.fillColor[0]+settings.fillColorHueOffset*settings.fillColorHueOffsetK*((this.colIdx-this.colN/2)/(this.colN+1))*(1+level))%360,this.strokeColor=guiHsvToP5Hsv(settings.strokeColor),this.strokeColor[0]=(this.strokeColor[0]+settings.strokeColorHueOffset*settings.strokeColorHueOffsetK*((this.colIdx-this.colN/2)/this.colN)*(1+level))%360;let f=hsv2hsl(...this.fillColor.map((i,idx)=>0==idx?i:i/100));this.hslF=f.map((i,idx)=>0==idx?i:100*i+"%").join(",");let s=hsv2hsl(...this.strokeColor.map((i,idx)=>0==idx?i:i/100));this.hslS=s.map((i,idx)=>0==idx?i:100*i+"%").join(",");let pv,pvn=new p5.Vector(this.dx,this.dy).normalize(),pvr=[1,-1].map((i,idx)=>[pvn.x*this.dw,pvn.y*this.dh].map((j,jdx)=>j*i));[this.graX1,this.graY1,this.graX2,this.graY2]=[...[].concat.apply([],pvr)]}animate(){}show(){this.showDeep(),this.showTop()}showDeep(){let[x,y,w,h]=[this.dx,this.dy,this.dw,this.dh],graX1,graY1,graX2,graY2;push(),translate(width/2,height/2);for(let i=settings.repeatorNum;i>=0;i--){let deep=Math.pow(1-i/settings.repeatorNum,settings.powK),k=map(1-deep*this.level,0,1,settings.minK,1);[x,y,w,h]=[this.dx,this.dy,this.dw,this.dh].map(j=>j*k);let r=this.dR*k;if(w-inBorder>0||h-inBorder>0){if(push(),1==settings.useGradient){let fA=(settings.fillA+(100-settings.fillA)/100*settings.fillA_add*i*k*this.level)/100,graF1=`hsla(${this.hslF},${fA*settings.graMaxA})`,graF2=`hsla(${this.hslF},${fA*settings.graMinA})`;[graX1,graY1,graX2,graY2]=graPointsOnSphere(x,y,w-inBorder,h-inBorder,r),drawingContext.fillStyle=setLinearGradient(graX1,graY1,graX2,graY2,graF1,graF2),noStroke()}else noStroke(),fill(...this.fillColor,settings.strokeAlpha+settings.strokeAlpha_add*i*k*this.level);rectOnSphere(x,y,w-inBorder,h-inBorder,r),pop()}if(push(),1==settings.useGradient){let sA=(settings.strokeAlpha+(100-settings.strokeAlpha)/100*settings.strokeAlpha_add*i*k*this.level)/100,graS1=`hsla(${this.hslS},${sA*settings.graMaxA})`,graS2=`hsla(${this.hslS},${sA*settings.graMinA})`;[graX1,graY1,graX2,graY2]=graPointsOnSphere(x,y,w,h,r),[graX1,graY1,graX2,graY2]=[graX1,graY1,graX2,graY2].map(i=>Math.round(i)),noFill(),drawingContext.strokeStyle=setLinearGradient(graX1,graY1,graX2,graY2,graS1,graS2),drawingContext.lineWidth=settings.strokeWeight_deep+settings.strokeWeight_deep_add*k}else noFill(),strokeWeight(settings.strokeWeight_deep+settings.strokeWeight_deep_add*k),stroke(...this.strokeColor,settings.strokeAlpha+settings.strokeAlpha_add*i*k*this.level);rectOnSphere(x,y,w,h,r),pop()}pop()}rectPoint(x,y,w,h){return[[x-w/2,y-h/2],[x+w/2,y-h/2],[x+w/2,y+h/2],[x-w/2,y+h/2]]}showTop(){let K=this.level,[x,y,w,h]=[this.dx,this.dy,this.dw,this.dh].map(j=>j),graX1,graY1,graX2,graY2,r=this.dR;if(push(),translate(width/2,height/2),w-inBorder>0||h-inBorder>0){if(push(),1==settings.useGradient){let fA=(settings.fillA+(100-settings.fillA)/100*settings.fillA_add*K)/100,graF1=`hsla(${this.hslF},${fA*settings.graMaxA})`,graF2=`hsla(${this.hslF},${fA*settings.graMinA})`;[graX1,graY1,graX2,graY2]=graPointsOnSphere(x,y,w-inBorder,h-inBorder,r),[graX1,graY1,graX2,graY2]=[graX1,graY1,graX2,graY2].map(i=>Math.round(i)),drawingContext.fillStyle=setLinearGradient(graX1,graY1,graX2,graY2,graF1,graF2),noStroke()}else noStroke(),fill(...this.fillColor,settings.fillA*K);rectOnSphere(x,y,w-inBorder,h-inBorder,r),pop()}if(push(),1==settings.useGradient){let sA=(settings.strokeAlpha+(100-settings.strokeAlpha)/100*settings.strokeAlpha_add*settings.repeatorNum*this.level)/100,graS1=`hsla(${this.hslS},${sA*settings.graMaxA})`,graS2=`hsla(${this.hslS},${sA*settings.graMinA})`;[graX1,graY1,graX2,graY2]=graPointsOnSphere(x,y,w,h,r),[graX1,graY1,graX2,graY2]=[graX1,graY1,graX2,graY2].map(i=>Math.round(i)),drawingContext.strokeStyle=setLinearGradient(graX1,graY1,graX2,graY2,graS1,graS2),drawingContext.lineWidth=settings.strokeWeight_main+settings.strokeWeight_main_add*K,noFill()}else noFill(),stroke(...this.strokeColor,settings.strokeAlpha+settings.strokeAlpha_add*settings.repeatorNum*this.level),strokeWeight(settings.strokeWeight_main+settings.strokeWeight_main_add*K);rectOnSphere(x,y,w,h,r),pop(),translate(-width/2,-height/2),pop()}}function setLinearGradient(x1,y1,x2,y2,c1,c2){let grd=drawingContext.createLinearGradient(x1,y1,x2,y2);return grd.addColorStop(0,c1),grd.addColorStop(1,c2),grd}class Column{constructor(w,h,x,colIdx,rowN,colN,R){let y,rowIdx;this.h=h,this.w=w,this.x=x,this.colIdx=colIdx,this.rowN=rowN,this.colN=colN,this.R=R,this.level=0,this.cells=[];for(let j=0;j<this.colN;j++){let y=-(j+.5-this.colN/2)*(celSize+padding);this.cells[j]=new Cell(w=this.w,h=this.h,x=this.x,y,rowIdx=j,colIdx=this.colIdx,rowN=this.rowN,colN=this.colN,R=this.R)}}update(level){level=map(level,0,255,0,1),this.level=level;for(let j=0;j<this.colN;j++){let l=level>j/this.colN?this.level:0;l=map(settings.colHiEffect,0,1,l,l+map(Math.abs(j-Math.floor(settings.colHighest*this.colN))/this.colN,0,.6,l,0)),this.cells[j].update(l)}}show(){for(let j=0;j<this.colN;j++)this.cells[j].show()}animate(){}}class Grid{constructor(row,col,R){this.row=row,this.col=col,this.columns=[];let Vmin=Math.min(width,height),Cmin=Vmin==height?this.col:this.row,sizeOfCell=(Vmin-2*margin)/Cmin-padding,w=celSize,h=celSize,x,colIdx,rowN,colN;this.R=R;for(let i=0;i<this.row;i++)x=(i+.5-this.row/2)*(celSize+padding),this.columns[i]=new Column(w,h,x,colIdx=i,rowN=this.row,colN=this.col,R=this.R)}update(levels){for(let i=0;i<row;i++)this.columns[i].update(levels[i])}show(){for(let i=0;i<row;i++)this.columns[i].show(...arguments)}animate(){}}let inputSound="music",fileInputId="musicFileInput",useLocalStorageSearchName="localStorage",showFrameRateSearchName="frameRate",settings={inputSound:inputSound,loadFile:function(){document.getElementById(fileInputId)?document.getElementById(fileInputId).click():guiLoadFileInit()},levelBase:.64,levelMulti:1.6,powK:.8,minK:.9,repeatorNum:3,strokeWeight_main:1,strokeWeight_main_add:2,strokeWeight_deep:1,strokeWeight_deep_add:2,strokeColor:{h:233,s:.5*Math.random()+.5,v:Math.random()},strokeColorHueOffset:30,strokeColorHueOffsetK:1,strokeAlpha:2,strokeAlpha_add:40,fillColor:{h:333,s:.5*Math.random()+.5,v:Math.random()},fillColorHueOffset:30,fillColorHueOffsetK:1,fillA:48,fillA_add:90,useGradient:!0,graMaxA:1,graMinA:0,bgAlpha:80,fftBins:4,fftSmoothing:.1,in_padding:24,grid_margin:60,cell_padding:8,cell_size:144,colHighest:.5,colHiEffect:.5,R:640,sphereDenominator:3},settingsRange={levelBase:[0,8],levelMulti:[0,48],fftBins:[6,15],fftSmoothing:[0,1],powK:[0,1],minK:[0,1],repeatorNum:[1,10],strokeWeight_main:[0,10],strokeWeight_main_add:[0,10],strokeWeight_deep:[0,10],strokeWeight_deep_add:[0,10],strokeColorHueOffset:[0,360],strokeColorHueOffsetK:[0,1],strokeAlpha:[0,100],strokeAlpha_add:[0,100],fillColorHueOffset:[0,360],fillColorHueOffsetK:[0,1],fillA:[0,100],fillA_add:[0,100],graMaxA:[0,1],graMinA:[0,1],bgAlpha:[0,100],in_padding:[0,256],grid_margin:[-Math.min(document.body.clientWidth,document.body.clientHeight)/2,Math.min(document.body.clientWidth,document.body.clientHeight)/2],cell_padding:[0,256],cell_size:[24,512],colHighest:[0,1],colHiEffect:[0,1],R:[100,2e3],sphereDenominator:[1,8]};function guiLoadFileInit(){let input,maxFileMb=10,fileTooBigAlert,fileTypeAlert;switch(navigator.language){case"zh-CN":fileTooBigAlert="文件不要超过 10Mb 哦～",fileTypeAlert="请加载音频或视频文件";break;default:fileTooBigAlert="The file is too large, no more than 10Mb ",fileTypeAlert="Please load an audio or video file"}document.getElementById(fileInputId)?input=document.getElementById(fileInputId):(input=document.createElement("input"),input.id=fileInputId,input.type="file",input.style="opacity:1;position:fixed;z-index:-999;top:-100%;left:-100%;",document.body.appendChild(input)),input.addEventListener("click",(function(){})),input.addEventListener("change",(function(){let file=input.files[0];file.size/1024/1024>10?alert(fileTooBigAlert):file.type.match(/(audio)|(video)/)?(r=new FileReader,r.onprogress=()=>{m.stop()},r.onload=function(){guiLoadMusicFile(r.result),m.soundName=file.name},r.readAsDataURL(file)):alert(fileTypeAlert)}))}function guiLoadMusicFile(r){"music"==inputSound?(m.switchMusic(r),setInputSound()):(m.switchMusic(r),inputSoundG.setValue("music"),setInputSound())}let guiPreset={preset:"cyber",closed:!1,remembered:{cyber:{0:{inputSound:"mic",levelBase:3.8,levelMulti:14.3,fftBins:7,fftSmoothing:.09,powK:.69,minK:.95,repeatorNum:5,strokeWeight_main:1,strokeWeight_main_add:2,strokeWeight_deep:1,strokeWeight_deep_add:1,strokeColor:{h:257.6470588235294,s:1,v:.9313725490196079},strokeColorHueOffset:9,strokeColorHueOffsetK:.14,strokeAlpha:5,strokeAlpha_add:100,fillColor:{h:250.58823529411762,s:1,v:.5588235294117647},fillColorHueOffset:16,fillColorHueOffsetK:.28,fillA:0,fillA_add:2,bgAlpha:72,graMaxA:.02,graMinA:1,in_padding:22,grid_margin:0,cell_padding:54,cell_size:184,colHighest:.51,colHiEffect:1,R:340,sphereDenominator:2}},acid:{0:{inputSound:"music",levelBase:.6,levelMulti:6,fftBins:6,fftSmoothing:.09,powK:.532,minK:.94,repeatorNum:6,strokeWeight_main:1,strokeWeight_main_add:12,strokeWeight_deep:0,strokeWeight_deep_add:1,strokeColor:{h:98.82352941176471,s:.8511029411764706,v:.9313725490196079},strokeColorHueOffset:155,strokeColorHueOffsetK:.12,strokeAlpha:10,strokeAlpha_add:70,fillColor:{h:218.82352941176472,s:1,v:.28431372549019607},fillColorHueOffset:34,fillColorHueOffsetK:.87,fillA:1,fillA_add:4,bgAlpha:29,graMaxA:.14,graMinA:1,in_padding:16,grid_margin:0,cell_padding:100,cell_size:256,colHighest:.49,colHiEffect:1,R:530,sphereDenominator:4}},Default:{0:{inputSound:"mic",levelBase:1.2,levelMulti:5.7,fftBins:6,fftSmoothing:.09,powK:.532,minK:.94,repeatorNum:6,strokeWeight_main:0,strokeWeight_main_add:2,strokeWeight_deep:1,strokeWeight_deep_add:2,strokeColor:{h:268.2352941176471,s:.26286764705882354,v:.166},strokeColorHueOffset:0,strokeColorHueOffsetK:0,strokeAlpha:3,strokeAlpha_add:70,fillColor:{h:257.6470588235294,s:.5863970588235294,v:.6274509803921569},fillColorHueOffset:20,fillColorHueOffsetK:.19,fillA:1,fillA_add:16,bgAlpha:64,graMaxA:.95,graMinA:0,in_padding:16,grid_margin:0,cell_padding:88,cell_size:162,colHighest:.48,colHiEffect:0,R:540,sphereDenominator:3}}},folders:{"sound level":{preset:"Default",closed:!0,folders:{}},"deep calc para":{preset:"Default",closed:!0,folders:{}},"stroke settings":{preset:"Default",closed:!0,folders:{}},"fill settings":{preset:"Default",closed:!0,folders:{}},"gradient settings":{preset:"Default",closed:!0,folders:{}},"grid and Cell settings":{preset:"Default",closed:!0,folders:{}}}},levelBaseMax=16,levelMultiMax=48,fft,amplitude,inBorder,margin,padding,celSize,row,col,startBoo=!1,onCtrlerBoo=!1,hintBoo=!1,onUploadBoo=!1,holdGuiBoo=!1,pageMargin=24,describeFont,titleFont,sphereFun,m,mStatus,pauseText="",loadingBoo=!0,errorBoo=!1,gui,soundFolder,deepCalcFolder,strokeFolder,fillFolder,gradientFolder,gridCellFolder,scale;function preload(){describeFont=loadFont("https://fonts.cdnfonts.com/s/13928/Nimbus-Sans-D-OT-Light_32752.woff"),titleFont=loadFont("https://fonts.cdnfonts.com/s/74329/Xhers Regular.woff"),m=new Musics(loopBoo=!0,showTextBoo=!1,disableConsoleErrBoo=!0,autoPlayBoo=!1),m.setCallBack(successFn=()=>{loadingBoo=!1,errorBoo=!1,setInputSound(),redraw()},errorFn=()=>{loadingBoo=!1,errorBoo=!0},loadingFn=()=>{loadingBoo=!0}),mStatus=function(){return m.musicStatus(failText="error",loadingText="loading",playingText="playing",pausedText="paused")},m.loadMusicFromJson("https://www.openprocessing.org/sketch/1454055/files/0__.json")}function init(){scale=displayDensity();let cW=windowWidth,cH=windowHeight;scale=1/scale,inBorder=settings.in_padding*scale,margin=settings.grid_margin*scale,padding=settings.cell_padding*scale,celSize=settings.cell_size*scale,1==startBoo?resizeCanvas(cW,cH):(cnv=createCanvas(cW,cH,P2D),cnv.mouseClicked(Clicked));let rowW=width-2*margin+padding,colH=height-2*margin+padding,k=rowW/colH,vmin=Math.min(width,height),minLi=3;col=Math.max(Math.floor(3*width/vmin),Math.floor(colH/(celSize+padding))),row=Math.max(Math.floor(3*height/vmin),Math.floor(k*col)),g=new Grid(row,col,settings.R),sphereFun=sphericalCoordinate(perspectiveK=.9,W=width,H=height,midX=width/2,midY=height/2,Math.PI/settings.sphereDenominator,Math.PI/(settings.sphereDenominator*(width/height))),rectMode(CENTER),strokeJoin(ROUND),colorMode(HSB,360,100,100,100),background(0),redraw()}function guiInit(){let preset,presetsArr=Object.keys(guiPreset.remembered);preset=presetsArr[Math.floor(Math.random()*presetsArr.length)],Object.keys(guiPreset.remembered).map(k=>{Object.keys(guiPreset.remembered[k]).map(n=>{delete guiPreset.remembered[k][n].inputSound})}),guiPreset.preset=String(preset),gui=new dat.GUI({load:guiPreset,preset:String(preset),hideable:!1}),gui.useLocalStorage=Boolean(eval(new URLSearchParams(location.search).get(useLocalStorageSearchName))),gui.width=420,gui.autoPlace=!0,gui.remember(settings),soundFolder=gui.addFolder("sound level"),deepCalcFolder=gui.addFolder("deep calc para"),strokeFolder=gui.addFolder("stroke settings"),fillFolder=gui.addFolder("fill settings"),gradientFolder=gui.addFolder("gradient settings"),gridCellFolder=gui.addFolder("grid and Cell settings"),inputSoundG=soundFolder.add(settings,"inputSound",["mic","music"]),loadFileG=soundFolder.add(settings,"loadFile"),levelBaseG=soundFolder.add(settings,"levelBase",...settingsRange.levelBase,.1),levelMultiG=soundFolder.add(settings,"levelMulti",...settingsRange.levelMulti,.1),fftBinsG=soundFolder.add(settings,"fftBins",...settingsRange.fftBins,1),fftSmoothingG=soundFolder.add(settings,"fftSmoothing",...settingsRange.fftSmoothing,.01),powKG=deepCalcFolder.add(settings,"powK",...settingsRange.powK,.001),minKG=deepCalcFolder.add(settings,"minK",...settingsRange.minK,.01),repeatorNumG=deepCalcFolder.add(settings,"repeatorNum",...settingsRange.repeatorNum,1),strokeWeight_mainG=strokeFolder.add(settings,"strokeWeight_main",...settingsRange.strokeWeight_main,1),strokeWeight_main_addG=strokeFolder.add(settings,"strokeWeight_main_add",...settingsRange.strokeWeight_main_add,1),strokeWeight_deepG=strokeFolder.add(settings,"strokeWeight_deep",...settingsRange.strokeWeight_deep,1),strokeWeight_deep_addG=strokeFolder.add(settings,"strokeWeight_deep_add",...settingsRange.strokeWeight_deep_add,1),strokeColorG=strokeFolder.addColor(settings,"strokeColor"),strokeColorHueOffsetG=strokeFolder.add(settings,"strokeColorHueOffset",...settingsRange.strokeColorHueOffset,1),strokeColorHueOffsetKG=strokeFolder.add(settings,"strokeColorHueOffsetK",...settingsRange.strokeColorHueOffsetK,.01),strokeAlphaG=strokeFolder.add(settings,"strokeAlpha",...settingsRange.strokeAlpha,1),strokeAlpha_addG=strokeFolder.add(settings,"strokeAlpha_add",...settingsRange.strokeAlpha_add,1),fillColorG=fillFolder.addColor(settings,"fillColor"),fillColorHueOffsetG=fillFolder.add(settings,"fillColorHueOffset",...settingsRange.fillColorHueOffset,1),fillColorHueOffsetKG=fillFolder.add(settings,"fillColorHueOffsetK",...settingsRange.fillColorHueOffsetK,.01),fillAG=fillFolder.add(settings,"fillA",...settingsRange.fillA,1),fillA_addG=fillFolder.add(settings,"fillA_add",...settingsRange.fillA_add,1),bgAlphaG=gui.add(settings,"bgAlpha",...settingsRange.bgAlpha,1),graMaxAG=gradientFolder.add(settings,"graMaxA",...settingsRange.graMaxA,.01),graMinAG=gradientFolder.add(settings,"graMinA",...settingsRange.graMinA,.01),useGradientG=gradientFolder.add(settings,"useGradient"),inBorder_0G=gridCellFolder.add(settings,"in_padding",...settingsRange.in_padding,1),margin_0G=gridCellFolder.add(settings,"grid_margin",...settingsRange.grid_margin,2),padding_0G=gridCellFolder.add(settings,"cell_padding",...settingsRange.cell_padding,2),celSize_0G=gridCellFolder.add(settings,"cell_size",...settingsRange.cell_size,2),colHighestG=gridCellFolder.add(settings,"colHighest",...settingsRange.colHighest,.01),colHiEffectG=gridCellFolder.add(settings,"colHiEffect",...settingsRange.colHiEffect,.01),rG=gridCellFolder.add(settings,"R",...settingsRange.R,10),sphereDenominatorG=gridCellFolder.add(settings,"sphereDenominator",...settingsRange.sphereDenominator,1),inputSoundG.setValue(inputSound),inputSoundG.onChange(()=>{inputSound=inputSoundG.getValue(),setInputSound()}),[powKG,minKG,repeatorNumG,graMaxAG,graMinAG,margin_0G,padding_0G,celSize_0G,rG,sphereDenominatorG].map(i=>{i.onChange((function(){init()}))}),inBorder_0G.onChange((function(){inBorder=settings.in_padding*scale}));let useCapture=!1;loadFileG.domElement.addEventListener("mouseover",(function(){onUploadBoo=!0}),useCapture),loadFileG.domElement.addEventListener("mouseout",(function(){onUploadBoo=!1}),useCapture),[gui].map(g=>{g.domElement.addEventListener("mouseover",guiMouseOver,useCapture),g.domElement.addEventListener("mouseout",guiMouseOut,useCapture)}),document.querySelector(".save-row").addEventListener("mouseover",guiMouseOver,useCapture),document.querySelector(".save-row").addEventListener("mouseout",guiMouseOut,useCapture)}function guiMouseOver(){onCtrlerBoo=!0}function guiMouseOut(){onCtrlerBoo=!1}function setup(){fft=new p5.FFT(settings.fftSmoothing,Math.pow(2,settings.fftBins)),amplitude=new p5.Amplitude,init(),guiLoadFileInit(),guiInit()}function draw(){!0===keyIsPressed&&Object.keys(keyDownList).map(k=>{keyIsDown(k)?keyCtrl(k):delete keyDownList[k]});let level=amplitude.getLevel();blendMode(BLEND),background(0,settings.bgAlpha),fft.analyze();let levels=fft.linAverages(Math.min(g.row,16));0==startBoo&&(levels=levels.map(i=>255*Math.random())),levels.length<g.row&&(levels=concat(levels,[...new Array(g.row-16)].map(i=>0))),levels=arrCleanAndExtend(levels,.005,(p,start,end)=>[...arguments].some(i=>void 0===i)?end:map(Math.pow(p,2)+(Math.random()-.5)/2,0,1,start,end)),levels.every(i=>i<.1)&&1==startBoo&&"mic"==inputSound&&(push(),translate(width/2,height/2),textAlign(CENTER,CENTER),textSize(Math.max(width,height)/64),fill(255),text("Using micphone, say sth 😉 ",0,0),pop()),g.update(levels.map(l=>l*(level*settings.levelMulti+settings.levelBase))),blendMode(SCREEN),g.show(),layout(),0==startBoo&&(hint(),noLoop()),1==hintBoo&&hint(),-1!=["paused","loading"].indexOf(mStatus())&&1==startBoo&&musicStatusText()}function layout(){let dpDensity=1;push(),fill(200),translate(pageMargin,0),translate(0,pageMargin),textFont(describeFont),textAlign(LEFT,TOP),textSize(12*dpDensity),text("music visualization",0,0),fill(255),translate(0,12*dpDensity),textFont(titleFont),textSize(36*dpDensity),text("< RECT >",0,0),pop(),push(),fill(200),translate(-pageMargin,0),translate(0,-pageMargin),textFont(describeFont),textAlign(RIGHT,BASELINE),textSize(18*dpDensity),text("Design and Coding by leizingyiu",width,height);let nameWidth=textWidth("Design and Coding by leizingyiu");push(),translate(0,-18*dpDensity),textSize(12*dpDensity),text(`music is ${m.soundName}`,width,height),pop(),translate(0,2*pageMargin),strokeWeight(2),stroke(200),line(width-nameWidth,0,width,0),pop(),push(),fill(233);let hintStr=pauseText+"\n";if("music"==inputSound){let mStr=m.musicStatus(failText="load error,please reload",loadingText="loading, please wait",playingText="music playing, click to pause",pausedText="music paused, click to play");if(0==mStr)switch(!0){case loadingBoo:mStr="loading , please wait";break;case errorBoo:mStr="load error , please refresh page";break;default:mStr="sth went wrong, please contact me https://github.com/leizingyiu to report bug"}hintStr+=mStr,hintStr+="; type r to switch song; type t to switch to microphone ; "}else hintStr+="Using microphone ; type t to switch to music ; click to pause and continue ;";hintStr+="\rtype s to save img ; [esc] for hint text ; [ ` ] for control panel",textSize(12*dpDensity),textFont(describeFont),textWidth(hintStr)>width-nameWidth-3*pageMargin&&(hintStr=hintStr.replace(/; /g,";\n")),textAlign(LEFT,BOTTOM),text(hintStr,pageMargin,height-pageMargin),1==Boolean(eval(new URLSearchParams(location.search).get(showFrameRateSearchName)))&&text(frameRate(),pageMargin,height-pageMargin-12*dpDensity*1.5),pop()}function Clicked(){if(1==onUploadBoo)return document.getElementById("musicFileInput").click(),!0;let pauseTextBoo=!1;if(1==onCtrlerBoo)return!1;0==startBoo&&(setInputSound(),startBoo=!0),0==holdGuiBoo&&gui.close(),1==hintBoo&&(hintBoo=!1,"playing"==mStatus())||("music"==inputSound&&m?1==isLooping()&&0==m.isPlaying()?m.play():1==isLooping()||1==m.isPlaying()?(m.pause(),noLoop(),pauseTextBoo=!0):0!=isLooping()&&0!=m.isPlaying()||(m.play(),loop()):(m&&m.stop(),isLooping()?(noLoop(),pauseTextBoo=!0):loop()),pauseText=1==pauseTextBoo?"paused, click to continue":"",draw())}function windowResized(){init()}function setInputSound(){if("mic"==inputSound){if(void 0!==m)try{m.stop()}catch(err){}"undefined"==typeof mic&&(userStartAudio(),mic=new p5.AudioIn),void 0===fft&&(fft=new p5.FFT(settings.fftSmoothing,Math.pow(2,settings.fftBins))),0==startBoo&&userStartAudio(),mic.start(),fft.setInput(mic),amplitude=mic}else isLooping()&&m.loop(),0==startBoo&&m.stop(),fft.setInput(m.music),amplitude=new p5.Amplitude,amplitude.setInput(m.music);levelBaseG.setValue("music"==inputSound?Math.max(.64,levelBaseG.getValue()):Math.max(1.5,levelBaseG.getValue())),levelMultiG.setValue("music"==inputSound?Math.max(9,levelMultiG.getValue()):Math.max(6,levelMultiG.getValue()))}function hint(hintCenter=!0){push();let d=32,title="mic"==inputSound?"T a p _ h e r e _ t o _ a c t i v a t e _ m i c , o r _ p a u s e":1==loadingBoo?"M u s i c  i s  l o a d i n g  ,  P l e a s e  w a i t \n":"T a b _ h e r e _ t o _ p l a y , o r _ p a u s e",hintText1="HOLD KEY  \nAND MOVE MOUSE  \n[1] + mouse = level base and multi\n[2] + mouse = fft\n[3] + mouse = powK and minK \n[4] + mouse = repeatorNum \n[a] + mouse = strokeWeight main & add\n[s] + mouse = strokeWeight deep & add\n[z] + mouse = stroke hue offset \n[x] + mouse = fill hue offset \n[q] + mouse = stroke alpha \n[w] + mouse = fill alpha \n",hintText2="[b] + mouse = fill color h s \n[g] + mouse = stroke color h s \n[m] + mouse = fill color s v \n[n] + mouse = stroke color s v \n[j] + mouse = fill and stroke s v \n[h] + mouse = fill and stroke hue \n[e] + mouse = gradient \n[y] + mouse = in_padding and cellsize \n[u] + mouse = grid_margin and cell_padding \n[i] + mouse = colHighest \n[o] + mouse = r and sphereDenominator \n[p] + mouse = background alpha \n",hintText3="PRESS \n [ ` ] for switch pannal open and close ,\n[ t ] for switch music  and mic , [ r ] fot switch song ,\n[esc] for hint ; hold [shift] for hint below";if(0==hintCenter){push();let hintText=[hintText1,hintText2,hintText3].map(i=>i.replace(/\n/g,"; ")).join("\n");fill(255),textSize(height/d/3);let hintRect=describeFont.textBounds(hintText,width/2,height/2,height/d/3);return translate(0,height-hintRect.h-pageMargin),rectMode(CENTER),textAlign(CENTER,BOTTOM),text(hintText,width/2,-hintRect.h-pageMargin,width-4*pageMargin),void pop()}translate(0,height/2),fill(100),stroke(0),strokeWeight(0),rectMode(CENTER),textLeading(0);let ttlRect=titleFont.textBounds(title,width/2,height/2,height/d);rectMode(CENTER),textLeading(32);let hintRect1=describeFont.textBounds(hintText1,0,height/2,height/d/2),hintRect2=describeFont.textBounds(hintText2,0,height/2,height/d/2),hintRect3=describeFont.textBounds(hintText3,0,height/2,height/d/2),txtpadding=20;rectMode(CENTER),push(),blendMode(BLEND),fill(0,80),rect(width/2,0,Math.max(ttlRect.w,hintRect1.w+hintRect2.w,hintRect3.w)+80,ttlRect.h+Math.max(hintRect1.h,hintRect2.h)+hintRect3.h+40+160),pop(),textFont(titleFont),textSize(height/d),textLeading(height/d*1.2),textAlign(CENTER,BOTTOM);let startPosition=-(ttlRect.h+40+Math.max(hintRect1.h,hintRect2.h)+hintRect3.h)/2;text(title,width/2,startPosition,width-2*settings.grid_margin),push(),textFont(describeFont),rectMode(CORNER),textSize(height/d/2),textLeading(32),textAlign(LEFT,TOP),text(hintText1,Math.max(width/2-hintRect1.w-20,0),startPosition+ttlRect.h+20,Math.min(width,hintRect1.w+20)),text(hintText2,Math.max(width/2+20,width/2),startPosition+ttlRect.h+20,Math.min(width,hintRect2.w+20)),rectMode(CENTER),textAlign(CENTER,TOP),text(hintText3,width/2,startPosition+ttlRect.h+60+Math.max(hintRect1.h,hintRect2.h),Math.min(width,hintRect3.w+20)),pop(),pop()}function musicStatusText(){let txt;switch(mStatus()){case"paused":txt="Music paused or finished,\nClick to play , or load music in the control panel ";break;case"loading":txt="Music is loading ,pls wait"}let d=24;push(),stroke(0),strokeWeight(0),rectMode(CENTER),textSize(height/d),textLeading(height/d*1.25);let ttlRect=titleFont.textBounds(txt,0,0,height/d);textAlign(CENTER,BOTTOM),textFont(titleFont),blendMode(BLEND),fill(0,36),rect(width/2,height/2,ttlRect.w+3*pageMargin,ttlRect.h+2*pageMargin),fill(100),translate(width/2,height/2),text(txt,0,0,width),pop()}function keyCtrl(keycode){if("number"==typeof(keycode=Number(keycode))&&isNaN(keycode))return;let mx=mouseX/width,my=mouseY/height,mdx=(.5-Math.abs(mx-.5))/.5,mdy=(.5-Math.abs(my-.5))/.5,px=(mouseX-pmouseX)/width,py=(mouseY-pmouseY)/height;switch(keycode){case 187:strokeWeight_deepG.setValue(strokeWeight_deepG.getValue()+1);break;case 189:strokeWeight_deepG.setValue(strokeWeight_deepG.getValue()-1);break;case 221:strokeWeight_mainG.setValue(strokeWeight_mainG.getValue()+1);break;case 219:strokeWeight_mainG.setValue(strokeWeight_mainG.getValue()-1);break;case 188:fillColorG.setValue({h:(settings.fillColor.h+5+360)%360,s:settings.fillColor.s,v:settings.fillColor.v});break;case 190:fillColorG.setValue({h:(settings.fillColor.h-5+360)%360,s:settings.fillColor.s,v:settings.fillColor.v});break;case 186:strokeColorG.setValue({h:(settings.strokeColor.h+5+360)%360,s:settings.strokeColor.s,v:settings.strokeColor.v});break;case 222:strokeColorG.setValue({h:(settings.strokeColor.h-5+360)%360,s:settings.strokeColor.s,v:settings.strokeColor.v});break;case 57:inBorder_0G.setValue(inBorder_0G.getValue()+5);break;case 48:inBorder_0G.setValue(inBorder_0G.getValue()-5);break;case 38:minKG.setValue(settings.minK+.05);break;case 40:minKG.setValue(settings.minK-.05);break;case 49:levelBaseG.setValue(map(mdx,0,1,...settingsRange.levelBase)),levelMultiG.setValue(map(mdy,0,1,...settingsRange.levelMulti));break;case 50:fftBinsG.setValue(map(mdx,0,1,...settingsRange.fftBins)),fftSmoothingG.setValue(map(mdy,0,1,...settingsRange.fftSmoothing));break;case 51:powKG.setValue(map(mdx,0,1,...settingsRange.powK)),minKG.setValue(map(mdy,0,1,...settingsRange.minK));break;case 52:repeatorNumG.setValue(map(mdx,0,1,...settingsRange.repeatorNum));break;case 65:strokeWeight_mainG.setValue(map(mx,0,1,...settingsRange.strokeWeight_main)),strokeWeight_main_addG.setValue(map(my,0,1,...settingsRange.strokeWeight_main_add));break;case 83:strokeWeight_deepG.setValue(map(mx,0,1,...settingsRange.strokeWeight_deep)),strokeWeight_deep_addG.setValue(map(my,0,1,...settingsRange.strokeWeight_deep_add));break;case 90:strokeColorHueOffsetG.setValue(map(mx,0,1,...settingsRange.strokeColorHueOffset)),strokeColorHueOffsetKG.setValue(map(my,0,1,...settingsRange.strokeColorHueOffsetK));break;case 88:fillColorHueOffsetG.setValue(map(mx,0,1,...settingsRange.fillColorHueOffset)),fillColorHueOffsetKG.setValue(map(my,0,1,...settingsRange.fillColorHueOffsetK));break;case 81:strokeAlphaG.setValue(map(mx,0,1,...settingsRange.strokeAlpha)),strokeAlpha_addG.setValue(map(my,0,1,...settingsRange.strokeAlpha_add));break;case 87:fillAG.setValue(map(mx,0,1,...settingsRange.fillA)),fillA_addG.setValue(map(my,0,1,...settingsRange.fillA_add));break;case 66:fillColorG.setValue({h:360*mx,s:1-my,v:settings.fillColor.v});break;case 71:strokeColorG.setValue({h:360*mx,s:1-my,v:settings.strokeColor.v});break;case 78:fillColorG.setValue({h:settings.fillColor.h,s:mouseX/width,v:1-mouseY/height});break;case 77:strokeColorG.setValue({h:settings.strokeColor.h,s:mouseX/width,v:1-mouseY/height});break;case 74:strokeColorG.setValue({h:settings.strokeColor.h,s:mouseX/width,v:1-mouseY/height}),fillColorG.setValue({h:settings.fillColor.h,s:mouseX/width,v:1-mouseY/height});break;case 72:strokeColorG.setValue({h:mouseX/width*360,s:settings.strokeColor.s,v:settings.strokeColor.v}),fillColorG.setValue({h:360*(1-mouseY/height),s:settings.fillColor.s,v:settings.fillColor.v});break;case 69:graMaxAG.setValue(map(mx,0,1,...settingsRange.graMaxA)),graMinAG.setValue(map(my,0,1,...settingsRange.graMinA));break;case 89:celSize_0G.setValue(map(mx,0,1,...settingsRange.cell_size)),inBorder_0G.setValue(map(my,0,1,...settingsRange.in_padding));break;case 85:margin_0G.setValue(map(mx,0,1,...settingsRange.grid_margin)),padding_0G.setValue(map(my,0,1,...settingsRange.cell_padding));break;case 73:colHighestG.setValue(map(my,0,1,...settingsRange.colHighest)),colHiEffectG.setValue(map(mx,0,1,...settingsRange.colHiEffect));break;case 79:rG.setValue(map(my,0,1,...settingsRange.R)),sphereDenominatorG.setValue(map(mx,0,1,...settingsRange.sphereDenominator));case 80:bgAlphaG.setValue(map(mdx+mdy,0,2,...settingsRange.bgAlpha));break;case 16:hint(!1),holdGuiBoo=!0;break;default:return!1}}let keyDownList={};function keyPressed(){switch(keyCode){case 192:1==gui.closed?gui.open():gui.close();break;case 84:return inputSoundG.setValue("music"==inputSound?"mic":"music"),!1;case 67:strokeColorG.setValue({h:360*Math.random(),s:.5*Math.random()+.5,v:Math.random()}),fillColorG.setValue({h:360*Math.random(),s:.5*Math.random()+.5,v:Math.random()});break;case 82:"music"==inputSound&&(m.switchMusic(),setInputSound());break;case 27:hintBoo=!hintBoo}return keyDownList[keyCode]=!0,init(),redraw(),!1}function keyReleased(){switch(delete keyDownList[keyCode],keyCode){case 16:holdGuiBoo=!1}}